<!DOCTYPE html>
<html>
<head>
	<meta charset="utf-8">
	<link rel="stylesheet" type="text/css" href="{{ url_for('static', filename='css/leaflet.css') }}">
	<title>Feed</title>
	<style>
		body{
			padding: 0;
			margin: 0;
		}
		#map{
			width: 800px;
			height: 500px;
		}

	</style>
</head>
<body>
	<div>
		<a href="{{ url_for('auth.logout') }}">Logout</a>
		<a href="{{ url_for('feed.get_user', username=current_user.username) }}">Profile</a>
	</div>
	<h1>Olá</h1>
	<div id="map"></div>
	<form id="form-new-post">
		{{ form.hidden_tag() }}
		<div>
			{{ form.title.label }}
			{{ form.title }}
		</div>
		<div>
			{{ form.body.label }}
			{{ form.body }}
		</div>
		{{ form.save_post() }}
	</form>
	<p id="respostas"></p>

	<script type="text/javascript" src="{{ url_for('static', filename='js/jquery-3.2.1.min.js') }}"></script>
	<script type="text/javascript" src="{{ url_for('static', filename='js/leaflet.js') }}"></script>
	<!--<script type="text/javascript" src="{{ url_for('static', filename='js/map.js') }}"></script>-->
	<script type="text/javascript">
		// REFATORAR TODO ESSE JS PARA UM ARQUIVO SEPARADO.
		var initialCoord = [-22.91, -43.20];
		var initialZoom = 13;

		var markerCoord = [-22.903719, -43.1760605];
		var markerMsg = "Olá mundo, <br> Olá LeafletJs";

		// inicializa o mapa.
		var map = L.map('map').setView(initialCoord, initialZoom);

		L.tileLayer('http://{s}.tile.osm.org/{z}/{x}/{y}.png', {
			attribution: '&copy; Contribuidores do <a href="http://osm.org/copyright">OpenStreetMap</a>'
		}).addTo(map);

		var iconProp = {
			iconUrl: "../static/img/marker-icon.png"
		,   iconSize: [44, 59]
		, 	iconAnchor: [22, 59]
		,   popupAnchor: [0, -50]
		};

		var iconM = L.icon(iconProp);

		L.marker(markerCoord, {icon: iconM})
			.addTo(map)
			.bindPopup(markerMsg)
			.openPopup();


		var latitude;
		var longitude;

		
		// teste para pegar latitude e longitude de lugar clicado no mapa.
		function mapClick(local){
			alert(local.latlng.lat.toString()+" :: "+local.latlng.lng.toString());
			latitude = parseFloat(local.latlng.lat.toString());
			longitude = parseFloat(local.latlng.lng.toString());
		}

		map.on('click', mapClick);

				$(document).ready(function() {
		        $('#form-new-post').submit(function (e) {
		        	
		        	var data = {};
		        	    var Form = this;
		        	    $.each(this.elements, function(i, v) {
		        	        var input = $(v);
		        	        data[input.attr("name")] = input.val();
		        	        delete data["undefined"];

		        	    });
		        	    data["latitude"] = latitude;
		        	    data["longitude"] = longitude;

		            var url = "{{ url_for('feed.feed') }}";

		            $.ajax({
		                type: "POST",
		                url: url,
		                dataType: 'json',
		                contentType: 'application/json; charset=utf-8',
		                data: JSON.stringify(data), 
		                success: function (data) {
		                    console.log(data) 
		                    $('#respostas').html("salvo");
		                }
		            });
		            e.preventDefault();
		        });
		        // Inject our CSRF token into our AJAX request.
		        $.ajaxSetup({
		            beforeSend: function(xhr, settings) {
		                if (!/^(GET|HEAD|OPTIONS|TRACE)$/i.test(settings.type) && !this.crossDomain) {
		                    xhr.setRequestHeader("X-CSRFToken", "{{ form.csrf_token._value() }}")
		                }
		            }
		        })
		    });
		/*
		function mostrarDados(){

			$.ajax({
		    	type: 'GET',
		    	url: '/listar',
		    	dataType: 'json',
		    	contentType: 'application/json; charset=utf-8',
		    	success: function(callback){
		    		console.log(callback);
		            for (var i=0; i < callback.length; i++){
		    		  $('#dados').append("<tr><td>"+callback[i].nome+"</td><td>"+callback[i].email+"</td></tr>");
		    	   }
		        },
		    	error: function(){
		    		$(this).html("error!");
		    	}    
		    });
		}
		*/
	</script>
</body>
</html>